$(document).ready(function() {
	
	//json = '{"3082634769":{"id":3082634769,"name":"","x":7187,"y":-2707,"size":13,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff4e07"},"3082636782":{"id":3082636782,"name":"","x":7200,"y":-2576,"size":13,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ffea07"},"3082637282":{"id":3082637282,"name":"jumbo","x":7507,"y":-3527,"size":183,"mass":334,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007701511,"update_tick":91,"color":"#68ff07"},"3082637824":{"id":3082637824,"name":"","x":7078,"y":-2881,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff0779"},"3082642104":{"id":3082642104,"name":"ghuzzzrzcrgfghn","x":6624,"y":-3358,"size":254,"mass":645,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007701511,"update_tick":91,"color":"#ff8807"},"3082654728":{"id":3082654728,"name":"","x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007699662,"update_tick":45},"3082654785":{"id":3082654785,"name":"","x":6258,"y":-3229,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007699982,"update_tick":53,"color":"#bfff07"},"3082654854":{"id":3082654854,"name":"","x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007701426,"update_tick":89},"3082657885":{"id":3082657885,"name":"","x":6200,"y":-3502,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#e7ff07"},"3082657899":{"id":3082657899,"name":"","x":6809,"y":-2691,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#df07ff"},"3082657907":{"id":3082657907,"name":"","x":7376,"y":-3172,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ffa507"},"3082657929":{"id":3082657929,"name":null,"x":5751,"y":-3456,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#0807ff"},"3082658161":{"id":3082658161,"name":"","x":7464,"y":-3297,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff07d0"},"3082658491":{"id":3082658491,"name":"","x":5804,"y":-3566,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#7607ff"},"3082658579":{"id":3082658579,"name":"","x":7535,"y":-2887,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff079c"},"3082658767":{"id":3082658767,"name":"","x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007700463,"update_tick":65},"3082658978":{"id":3082658978,"name":"","x":7342,"y":-2625,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007701186,"update_tick":83,"color":"#07ffb6"},"3082659369":{"id":3082659369,"name":"","x":7384,"y":-2849,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#c807ff"},"3082659431":{"id":3082659431,"name":"","x":5671,"y":-3571,"size":12,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#28ff07"},"3082659585":{"id":3082659585,"name":"","x":6697,"y":-3072,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#9cff07"},"3082659798":{"id":3082659798,"name":"","x":7539,"y":-2721,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#07ffea"},"3082659842":{"id":3082659842,"name":"","x":6109,"y":-3605,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#e407ff"},"3082660193":{"id":3082660193,"name":"","x":5980,"y":-3309,"size":10,"mass":1,"virus":false,"mine":true,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#4207ff"},"3082660437":{"id":3082660437,"name":"","x":6457,"y":-2679,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#07ff88"},"3082660439":{"id":3082660439,"name":"","x":7221,"y":-2857,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#ffc807"},"3082660710":{"id":3082660710,"name":"","x":5796,"y":-2726,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#9f07ff"},"3082660997":{"id":3082660997,"name":"","x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007700781,"update_tick":73},"3082661049":{"id":3082661049,"name":"","x":7683,"y":-2549,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#ff8e07"},"3082661097":{"id":3082661097,"name":"","x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007700661,"update_tick":70},"3082661124":{"id":3082661124,"name":"","x":6344,"y":-2997,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff07d0"},"3082661224":{"id":3082661224,"name":"wojak","x":6954,"y":-2497,"size":67,"mass":44,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007699021,"update_tick":29,"color":"#ff07a2"},"3082661368":{"id":3082661368,"name":"","x":6032,"y":-2871,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#8807ff"},"3082661374":{"id":3082661374,"name":"","x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007700624,"update_tick":69},"3082661421":{"id":3082661421,"name":"","x":7552,"y":-2659,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#07ff71"},"3082661501":{"id":3082661501,"name":"","x":5797,"y":-3257,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#0785ff"},"3082661559":{"id":3082661559,"name":"","x":5991,"y":-2863,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#ff4e07"},"3082661608":{"id":3082661608,"name":"","x":5973,"y":-3050,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#07b3ff"},"3082661756":{"id":3082661756,"name":"","x":6178,"y":-2826,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697904,"update_tick":1,"color":"#ff7c07"},"3082662313":{"id":3082662313,"name":"","x":7060,"y":-2802,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff074b"},"3082663112":{"id":3082663112,"name":"","x":7219,"y":-2731,"size":11,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#07ff7c"},"3082663435":{"id":3082663435,"name":"","x":6514,"y":-2954,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#ff0807"},"3082663537":{"id":3082663537,"name":null,"x":0,"y":0,"size":0,"mass":0,"virus":false,"mine":false,"destroyed":false,"visible":false,"last_update":1459007700624,"update_tick":69},"3082664668":{"id":3082664668,"name":"","x":7665,"y":-2920,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#e407ff"},"3082664753":{"id":3082664753,"name":"","x":7416,"y":-2996,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#07adff"},"3082664938":{"id":3082664938,"name":"","x":6462,"y":-2723,"size":10,"mass":1,"virus":false,"mine":false,"destroyed":false,"visible":true,"last_update":1459007697899,"update_tick":1,"color":"#07ff5a"}}';
	//var game_detail = JSON.parse(json);
	var socket = io.connect();

	var screen_x = 0;
	var screen_y = 0;
	var borderSize = 20;
			
	var canvas = document.getElementById("canvasAgario");
	canvas.width = window.innerWidth - borderSize;
    canvas.height = window.innerHeight - borderSize;
	var ctx = canvas.getContext('2d');
	
	var start = new Date().getTime();

	
	$(document).keydown(function(e) {
		var end = new Date().getTime();
		var time = end - start;
		
		if (time < 10)
			return;
		
		start = new Date().getTime();
	
		var posx = screen_x + canvas.width / 2;
		var posy = screen_y + canvas.height / 2;
		switch(e.which) {
			case 37: // left
				socket.emit('moveTo', posx-2000, posy);
			break;

			case 38: // up
			socket.emit('moveTo', posx, posy-2000);
			break;

			case 39: // right
			socket.emit('moveTo', posx+2000, posy);
			break;

			case 40: // down
			socket.emit('moveTo', posx, posy+2000);
			break;

			default: return; // exit this handler for other keys
		}
		e.preventDefault(); // prevent the default action (scroll / move caret)
	});
	
	socket.on('GAME_DETAIL', function(game_detail) {
		game_detail = JSON.parse(game_detail);
		for (var ball_id in game_detail)
		{
			if (game_detail[ball_id].mine)
			{
				var my_ball = game_detail[ball_id];
				screen_x = my_ball.x - canvas.width / 2;
				screen_y = my_ball.y - canvas.height / 2;
				break;
			}
		}
		
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		
		for (var ball_id in game_detail)
		{
			var ball = game_detail[ball_id];
			if (ball.x == 0 || ball.destroyed || !ball.visible)
			{ console.log("WUT");	continue; }

			ball.x -= screen_x;
			ball.y -= screen_y;

			ctx.beginPath();
			ctx.arc(ball.x, ball.y, ball.size, 0, 2 * Math.PI, false);
			
			ctx.fillStyle = ball.color;
			if (ball.virus)
			{
				ctx.fillStyle = "rgba(255, 123, 123, 0.5)";
				ctx.lineWidth = 4;
				ctx.strokeStyle = '#FF3333';
				ctx.stroke();
			}
			else if (ball.size > 15)
			{
				ctx.lineWidth = 4;
				ctx.strokeStyle = '#AAAAAA';
				ctx.stroke();
			}
			
			ctx.fill();
			ctx.closePath();
		}
	
		ctx.beginPath();
		ctx.rect(0, 0, canvas.width, canvas.height);
		ctx.strokeStyle = '#FFFFFF';
		ctx.stroke();
		ctx.closePath();
	});
});